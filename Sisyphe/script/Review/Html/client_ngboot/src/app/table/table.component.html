<app-loading #loading></app-loading>
<!-- Page content -->
<div class="page d-flex flex-column">
  <!-- Bootstrap Navigation bar : dark-grey bar -->
  <nav class="navbar sticky-top navbar-expand-md navbar-dark bg-dark">
    <!-- brand logo -->
    <div class="navbar-brand ">
      <app-about></app-about>
    </div>
    <button class="navbar-toggler" type="button" (click)="isMenuCollapsed = !isMenuCollapsed">
      <span class="navbar-toggler-icon"></span>
    </button>
    <!-- Collapsed menu for small screen -->
    <div [ngbCollapse]="isMenuCollapsed" class="collapse navbar-collapse" >
      <div class="navbar-nav ml-auto my-2 my-md-0">
        <form class="navbar-form navbar-right d-flex flex-column flex-md-row" role="export">
          <button class="btn btn-secondary d-inline-flex align-items-center my-1 my-md-0 mr-md-2" (click)="newDerogationFile()" type="submit">
            <bi name="file-earmark-text-fill" class="icon-button-text"></bi>New derogation file
          </button>
          <label for="files" class="btn btn-secondary d-inline-flex align-items-center my-1 my-md-0 mr-md-2">
            <bi name="upload" class="icon-button-text"></bi>Load derogation file
          </label>
          <input id="files" type='file' accept=".csv" filelist-bind (change)="loadDerogationFile($event)" style="display:none">
          <button class="btn btn-secondary d-inline-flex align-items-center my-1 my-md-0 mr-md-2" (click)="saveDerogationFile()" type="submit">
            <bi name="download" class="icon-button-text"></bi>Save derogation file
          </button>
          <button class="btn btn-secondary d-inline-flex align-items-center my-1 my-md-0 mr-md-2" (click)="exportView()" type="submit">
            <bi name="download" class="icon-button-text"></bi>Export view
          </button>
        </form>
      </div>
    </div>
  </nav>
  <!-- View content -->
  <div class="view flex-grow-1 d-flex flex-column">
    <div class="filter-panel d-flex flex-row">
      <div class="filter-label"><b>SQLite Where clause: </b></div>
      <div class="input-group my-1 my-md-0 mr-md-2">
        <input type="text" placeholder="filter errors" class="form-control" [(ngModel)]="query" (keyup)="$event.keyCode == 13 && filterClicked()"/>
        <div class="input-group-append">
          <button class="btn btn-secondary" type="submit" (click)="filterClicked()">
            <bi name="search" class="icon-button"></bi>
          </button>
        </div>
      </div>
      <app-sql-info class="filter-label"></app-sql-info>
    </div>
    <div class="alert alert-danger" role="alert" style="margin: 5px 20px 5px 20px; white-space: pre-line;" *ngIf="consoleText!=''">
      {{ consoleText }}
    </div>
    <div class="alert alert-warning alert-dismissible" role="alert" style="margin: 5px 20px 5px 20px;" *ngIf="!warningClosed && table.blameError">
      <button class="close" data-dismiss="alert" aria-label="close" (click)="warningClosed = true">&times;</button>
      <strong>Warning!</strong> Shallow clone detecté, informations git blame manquantes et édition de derogations désactivée. 
    </div>
    <div class="d-flex flex-row" style="margin: 5px 20px 0 20px;">
      <button class="btn btn-secondary d-inline-flex align-items-center mr-md-2" type="submit" *ngIf="derogationLoaded" (click)="isEditDerogationCollapsed=!isEditDerogationCollapsed"> 
        <div *ngIf="isEditDerogationCollapsed; then chevronDown else chevronUp"></div>
        <ng-template #chevronUp><bi name="chevron-bar-up" class="icon-button"></bi></ng-template>
        <ng-template #chevronDown><bi name="chevron-bar-down" class="icon-button"></bi></ng-template>
      </button>
      <div #collapse="ngbCollapse" [(ngbCollapse)]="isEditDerogationCollapsed || !derogationLoaded" style="width: 100%; margin: 0 20px 0 0;">
        <div class="d-flex flex-row">
          <textarea class="form-control" placeholder="Edit derogation for all filtered errors" [(ngModel)]="derogation" style="margin: 0px 5px 0px 5px;"></textarea>
          <div class="input-group-btn">
            <button class="btn btn-secondary" type="submit" (click)="editAllClicked()" style="height: 100%;">
              <bi name="pencil-square" class="icon-button"></bi>
            </button>
          </div> 
        </div>
      </div>
    </div>
    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th scope="col" class="text-align-center">FilePath</th>
          <th scope="col" class="text-align-center">FileName</th>
          <th scope="col" class="text-align-center">FileType<br><div style="font-size: xx-small;">(1:header,2:source)</div></th>
          <th scope="col" class="text-align-center">RuleNumber</th>
          <th scope="col" class="text-align-center">RuleCategory</th>
          <th scope="col" class="text-align-center">RuleDescription</th>
          <th scope="col" class="text-align-center">LineNumber</th>
          <th scope="col" class="text-align-center">NewError<br><div style="font-size: xx-small;">(0:false,1:true)</div></th>
          <th scope="col" class="text-align-center">CommitHash</th>
          <th scope="col" class="text-align-center">CommitDate</th>
          <th scope="col" class="text-align-center">CommitAuthor</th>
          <th scope="col" class="text-align-center">ErrorDerogation</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of table.rows">
          <td scope="row" class="text-align-center">{{ item.path }}</td>
          <td scope="row" class="text-align-center">{{ item.name }}</td>
          <td scope="row" class="text-align-center">{{ item.type}}</td>
          <td scope="row" class="text-align-center">{{ item.ruleNumber }}</td>
          <td scope="row" class="text-align-center">{{ item.category }}</td>
          <td scope="row" class="text-align-center">{{ item.description }}</td>
          <td scope="row" class="text-align-center">{{ item.lineNumber }}</td>
          <td scope="row" class="text-align-center">{{ item.isNew }}</td>
          <td scope="row" class="text-align-center">{{ item.commitHash }}</td>
          <td scope="row" class="text-align-center">{{ item.commitDate }}</td>
          <td scope="row" class="text-align-center">{{ item.commitAuthor }}</td>
          <td scope="row" class="text-align-center">
            <div class="d-flex flex-row" style="width:300px;">
              <textarea class="form-control" [(ngModel)]="item.derogation" placeholder="Edit derogation" [disabled]="!derogationLoaded || item.commitHash===''" (focus)="textDerogationClicked(item)"></textarea>
              <div class="d-flex flex-column" style="width:40px; margin: 5px" *ngIf="item.derogationWrote">
                <button class="btn btn-success" style="margin-bottom: 2px" (click)="validDerogationClicked(item)"><bi name="check-lg" class="icon-button-text"></bi></button>
                <button class="btn btn-danger" style="margin-top: 2px" (click)="cancelDerogationClicked(item)"><bi name="trash" class="icon-button-text"></bi></button>
              </div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  
    <nav aria-label="Page navigation" class="navbar">
      <div class="container-fluid">
        <ul class="pagination">
          <li class="page-item" *ngIf="table.pageMin>1">
            <a class="page-link bg-secondary text-white" (click)="previousPageClicked()" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          <li *ngFor="let index of pages" class="page-item"><a class="page-link text-white" [ngClass]="index===selectedIndex ? 'bg-dark' : 'bg-secondary'" (click)="paginationClicked(index)">{{index}}</a></li>
          <li class="page-item" *ngIf="table.pageMax<table.pageCount">
            <a class="page-link bg-secondary text-white" (click)="nextPageClicked()" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
              <span class="sr-only">Next</span>
            </a>
          </li>
        </ul>
        <div class="navbar-right pagination-select">
          <select class="custom-select bg-secondary text-white" [(ngModel)]="pageSize">
            <option [ngValue]="10" (click)="selectClicked(10)">10 items per page</option>
            <option [ngValue]="100" (click)="selectClicked(100)">100 items per page</option>
            <option [ngValue]="1000" (click)="selectClicked(1000)">1000 items per page</option>
          </select>
        </div>
      </div>
    </nav>
  </div>
</div>